- task: AzureCLI@2
  name: deploy_managed_endpoint
  displayName: Deploy Managed Endpoint
  inputs:
    azureSubscription: ${{parameters.serviceConnection}}
    scriptType: bash
    scriptLocation: inlineScript
    failOnStandardError: true
    inlineScript: |
      set -euo pipefail

      az configure --defaults workspace=${{parameters.amlWorkspace}} group=${{parameters.resourceGroup}}

      ENDPOINT_FILE="endpoint-${{ lower(parameters.bu) }}.yml"
      ENDPOINT_NAME="$(yq '.name' "$ENDPOINT_FILE")"
      KEY_VAULT_NAME="${{ parameters.keyVaultName }}"

      EXISTING_COUNT="$(az ml online-endpoint list --query "[?name=='$ENDPOINT_NAME'] | length(@)" -o tsv)"
      if [ "$EXISTING_COUNT" = "0" ]; then
        echo "Create endpoint..."
        az ml online-endpoint create -f "$ENDPOINT_FILE"
      fi

      for i in {1..60}; do
        STATE="$(az ml online-endpoint show -n "$ENDPOINT_NAME" --query provisioning_state -o tsv)"
        echo "Endpoint provisioning_state: $STATE"
        if [ "$STATE" = "Succeeded" ]; then
          break
        fi
        if [ "$STATE" = "Failed" ]; then
          az ml online-endpoint show -n "$ENDPOINT_NAME" -o jsonc || true
          exit 1
        fi
        sleep 10
      done

      if [ -n "$KEY_VAULT_NAME" ]; then
        ENDPOINT_KEY="$(az ml online-endpoint get-credentials -n "$ENDPOINT_NAME" -o tsv --query primaryKey)"
        az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "UnifiedModelApiKey" --value "$ENDPOINT_KEY"
      fi
  workingDirectory: src/deployment/managed_endpoint/${{parameters.environment}}/




    #################################################
    #################################################
    #################################################
- task: AzureCLI@2
  name: deploy_model_managed_endpoint
  displayName: Deploy Model To Managed Endpoint
  inputs:
    azureSubscription: ${{parameters.serviceConnection}}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      az configure --defaults workspace=${{parameters.amlWorkspace}} group=${{parameters.resourceGroup}}

      MODEL_FILE="model-${{ lower(parameters.bu) }}.yml"
      ENDPOINT_NAME="$(yq '.endpoint_name' "$MODEL_FILE")"
      DEPLOYMENT_NAME="$(yq '.name' "$MODEL_FILE")"

      EXISTING_COUNT="$(az ml online-deployment list -e "$ENDPOINT_NAME" --query "[?name=='$DEPLOYMENT_NAME'] | length(@)" -o tsv)"

      if [ "$EXISTING_COUNT" = "0" ]; then
        echo "Create deployment for $DEPLOYMENT_NAME..."
        az ml online-deployment create -f "$MODEL_FILE"
      else
        echo "Update deployment for $DEPLOYMENT_NAME..."
        az ml online-deployment update -f "$MODEL_FILE"
      fi

      for i in {1..90}; do
        STATE="$(az ml online-deployment show -n "$DEPLOYMENT_NAME" -e "$ENDPOINT_NAME" --query provisioning_state -o tsv)"
        echo "Deployment provisioning_state: $STATE"
        if [ "$STATE" = "Succeeded" ]; then
          break
        fi
        if [ "$STATE" = "Failed" ]; then
          az ml online-deployment show -n "$DEPLOYMENT_NAME" -e "$ENDPOINT_NAME" -o jsonc || true
          az ml online-deployment get-logs -n "$DEPLOYMENT_NAME" -e "$ENDPOINT_NAME" --lines 500 || true
          exit 1
        fi
        sleep 10
      done

      az ml online-endpoint update --name "$ENDPOINT_NAME" --traffic "$DEPLOYMENT_NAME=100"
  workingDirectory: src/deployment/managed_endpoint/${{parameters.environment}}/
